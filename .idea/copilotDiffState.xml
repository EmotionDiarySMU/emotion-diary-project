<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/main/java/com/diary/emotion/DB/DatabaseManager.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/com/diary/emotion/DB/DatabaseManager.java" />
              <option name="originalContent" value="package com.diary.emotion.DB;&#10;&#10;import java.sql.Connection;&#10;import java.sql.DriverManager;&#10;import java.sql.PreparedStatement;&#10;import java.sql.ResultSet;&#10;import java.sql.SQLException;&#10;import java.sql.Statement;&#10;import java.sql.Timestamp;&#10;import java.time.LocalDateTime;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;import com.diary.emotion.login.AuthenticationFrame;&#10;&#10;// ⭐️ 프로그램 실행 중 DB 연결/삽입/조회/수정 등을 관리하는 전용 클래스&#10;public class DatabaseManager {&#10;&#10;    // ⭐️ 이 클래스는 'emotion_diary' DB에 바로 연결&#10;    private static final String DB_URL = &quot;jdbc:mysql://localhost:3306/emotion_diary?serverTimezone=Asia/Seoul&quot;;&#10;&#9;private static final String DB_ID = &quot;root&quot;;&#10;&#9;private static final String DB_PW = &quot;U9Bsi7sj1*&quot;; // 비번&#10;&#9;&#10;    // 1. DB 연결을 가져오는 메소드&#10;    public static Connection getConnection() throws Exception {&#10;        return DriverManager.getConnection(DB_URL, DB_ID, DB_PW);&#10;    }&#10;    &#10;    // 처음 DB 생성을 위한 URL&#10;    private static final String Initial_DB_URL = &quot;jdbc:mysql://localhost:3306/?serverTimezone=Asia/Seoul&quot;;&#10;    &#10;    // DB 생성 메서드&#10;    public static boolean createDatabase() {&#10;&#9;&#10;    &#9;try (Connection conn = DriverManager.getConnection(Initial_DB_URL, DB_ID, DB_PW);&#10;    &#9;&#9;     Statement stmt = conn.createStatement();&#10;    &#9;&#9;     ResultSet rs = stmt.executeQuery(&quot;SHOW DATABASES LIKE 'emotion_diary'&quot;)) {&#10;&#10;    &#9;&#9;    if (!rs.next()) { // 해당 DB가 없으면 실행&#10;            &#9;&#10;            &#9;// DB 생성&#10;            &#9;String sql = &quot;CREATE DATABASE emotion_diary CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci&quot;; // 이모지 저장 및 대소문자 구분 없는 유니코드 문자셋 설정&#10;&#9;&#9;        stmt.executeUpdate(sql);&#10;&#9;&#9;        &#10;&#9;&#9;        // 해당 DB 사용&#10;&#9;&#9;        String useEmotion_diaryDB = &quot;USE emotion_diary&quot;;&#10;&#9;&#9;        stmt.executeUpdate(useEmotion_diaryDB);&#10;&#9;&#10;&#9;            // user 테이블 생성&#10;&#9;            String createTable_user = &quot;&quot;&quot;&#10;&#9;                CREATE TABLE user (&#10;&#9;                    user_id VARCHAR(20) PRIMARY KEY,&#10;&#9;                    user_pw VARCHAR(20) NOT NULL&#10;&#9;                )&#10;&#9;            &quot;&quot;&quot;;&#10;&#9;            stmt.executeUpdate(createTable_user);&#10;&#9;            &#10;&#9;            // diary 테이블 생성&#10;&#9;            String createTable_diary = &quot;&quot;&quot;&#10;&#9;                CREATE TABLE diary (&#10;&#9;                    entry_id INTEGER AUTO_INCREMENT PRIMARY KEY,&#10;&#9;                    user_id VARCHAR(20) NOT NULL,&#10;&#9;                    title VARCHAR(50),&#10;&#9;                    content TEXT,&#10;&#9;                    stress_level INTEGER NOT NULL,&#10;&#9;                    entry_date DATETIME NOT NULL,&#10;&#9;                    modify_date DATETIME,&#10;&#9;                    FOREIGN KEY (user_id) REFERENCES user(user_id)&#10;&#9;                )&#10;&#9;            &quot;&quot;&quot;;&#10;&#9;            stmt.executeUpdate(createTable_diary);&#10;&#9;            &#10;&#9;            // emotion 테이블 생성&#10;&#9;            String createTable_emotion = &quot;&quot;&quot;&#10;&#9;                CREATE TABLE emotion (&#10;&#9;                    emotion_id INTEGER AUTO_INCREMENT PRIMARY KEY,&#10;&#9;                    entry_id INTEGER NOT NULL,&#10;&#9;                    emotion_level INTEGER NOT NULL,&#10;&#9;                    emoji_icon VARCHAR(10) NOT NULL,&#10;&#9;                    FOREIGN KEY (entry_id) REFERENCES diary(entry_id)&#10;&#9;                )&#10;&#9;            &quot;&quot;&quot;;&#10;&#9;            stmt.executeUpdate(createTable_emotion);&#10;&#9;                &#10;&#9;            // question 테이블 생성&#10;&#9;            String createTable_question = &quot;&quot;&quot;&#10;&#9;                CREATE TABLE question (&#10;&#9;                    question_id INTEGER AUTO_INCREMENT PRIMARY KEY,&#10;&#9;                    question_text VARCHAR(100) NOT NULL&#10;&#9;                )&#10;&#9;            &quot;&quot;&quot;;&#10;&#9;            stmt.executeUpdate(createTable_question);&#10;            }&#10;&#10;&#9;        return true;&#10;&#9;        &#10;&#9;    } catch (Exception e) {&#10;&#9;    &#9;System.err.println(&quot;일기 삭제 중 오류 발생:&quot;);&#10;&#9;    &#9;e.printStackTrace(); // 오류 콘솔에 출력 (디버깅용)&#10;&#9;    &#9;&#10;&#9;    &#9;return false;&#10;&#9;    }&#10;&#9;}&#10;    &#10;    // 1. 로그인 기능: ID와 비번을 받아서 맞으면 true, 틀리면 false 반환&#10;    public boolean checkLogin(String id, String pw) {&#10;        String sql = &quot;SELECT user_pw FROM user WHERE user_id = ?&quot;;&#10;        try (Connection conn = DriverManager.getConnection(DB_URL, DB_ID, DB_PW);&#10;             PreparedStatement pstmt = conn.prepareStatement(sql)) {&#10;&#10;            pstmt.setString(1, id);&#10;            try (ResultSet rs = pstmt.executeQuery()) {&#10;                if (rs.next()) {&#10;                    return pw.equals(rs.getString(&quot;user_pw&quot;));&#10;                }&#10;            }&#10;&#10;        } catch (Exception e) {&#10;            e.printStackTrace();&#10;        }&#10;        return false;&#10;    }&#10;&#10;    // 2. 회원가입 기능: 성공(1), 중복ID(0), 에러(-1) 반환&#10;    public int registerUser(String id, String pw) {&#10;        String checkSql = &quot;SELECT user_id FROM user WHERE user_id = ?&quot;;&#10;        String insertSql = &quot;INSERT INTO user (user_id, user_pw) VALUES (?, ?)&quot;;&#10;&#10;        try (Connection conn = DriverManager.getConnection(DB_URL, DB_ID, DB_PW)) {&#10;            &#10;            // ID 중복 확인&#10;            try (PreparedStatement checkStmt = conn.prepareStatement(checkSql)) {&#10;                checkStmt.setString(1, id);&#10;                try (ResultSet rs = checkStmt.executeQuery()) {&#10;                    if (rs.next()) return 0; &#10;                }&#10;            }&#10;&#10;            // 회원가입&#10;            try (PreparedStatement insertStmt = conn.prepareStatement(insertSql)) {&#10;                insertStmt.setString(1, id);&#10;                insertStmt.setString(2, pw);&#10;                insertStmt.executeUpdate();&#10;                return 1;&#10;            }&#10;&#10;        } catch (Exception e) {&#10;            e.printStackTrace();&#10;            return -1;&#10;        }&#10;    }&#10;&#10;    // 2. 일기 항목을 DB에 삽입하는 메소드&#10;    public static boolean insertDiaryEntry(String title, String content, int stressLevel, &#10;                                           List&lt;String&gt; emotionIcons, List&lt;Integer&gt; emotionValuesList) {&#10;        &#10;        Connection conn = null;&#10;        PreparedStatement pstmtDiary = null;&#10;        PreparedStatement pstmtEmotion = null;&#10;        ResultSet rs = null;&#10;&#10;        String sqlInsertDiary = &quot;INSERT INTO diary (user_id, title, content, stress_level, entry_date) VALUES (?, ?, ?, ?, ?)&quot;;&#10;        String sqlInsertEmotion = &quot;INSERT INTO emotion (entry_id, emotion_level, emoji_icon) VALUES (?, ?, ?)&quot;;&#10;&#10;        try {&#10;            conn = getConnection(); &#10;            conn.setAutoCommit(false); &#10;            &#10;            // --- 1단계: 'diary' 테이블에 삽입 ---&#10;            pstmtDiary = conn.prepareStatement(sqlInsertDiary, Statement.RETURN_GENERATED_KEYS);&#10;            pstmtDiary.setString(1, AuthenticationFrame.loggedInUserId);&#10;            pstmtDiary.setString(2, title.trim()); // 앞 뒤 공백 제거&#10;            pstmtDiary.setString(3, content);&#10;            pstmtDiary.setInt(4, stressLevel);&#10;            pstmtDiary.setTimestamp(5, Timestamp.valueOf(LocalDateTime.now()));&#10;            &#10;            int rowsAffected = pstmtDiary.executeUpdate();&#10;            &#10;            if (rowsAffected == 0) {&#10;                throw new Exception(&quot;Diary insert failed, no rows affected.&quot;);&#10;            }&#10;&#10;            // --- 2단계: 방금 삽입된 'diary'의 entry_id 가져오기 ---&#10;            rs = pstmtDiary.getGeneratedKeys();&#10;            int entryId;&#10;            if (rs.next()) {&#10;                entryId = rs.getInt(1); &#10;            } else {&#10;                throw new Exception(&quot;Diary insert failed, no ID obtained.&quot;);&#10;            }&#10;            &#10;            // --- 3단계: 'emotion' 테이블에 삽입 ---&#10;            pstmtEmotion = conn.prepareStatement(sqlInsertEmotion);&#10;            &#10;            for (int i = 0; i &lt; emotionIcons.size(); i++) {&#10;                pstmtEmotion.setInt(1, entryId);&#10;                pstmtEmotion.setInt(2, emotionValuesList.get(i));&#10;                pstmtEmotion.setString(3, emotionIcons.get(i));&#10;                pstmtEmotion.addBatch();&#10;            }&#10;            pstmtEmotion.executeBatch(); &#10;&#10;            // --- 4단계: 최종 반영 ---&#10;            conn.commit();&#10;            return true; // 성공!&#10;&#10;        } catch (Exception e) {&#10;            e.printStackTrace();&#10;            if (conn != null) {&#10;                try {&#10;                    conn.rollback(); // 실패 시 되돌리기&#10;                } catch (Exception ex) {&#10;                    ex.printStackTrace();&#10;                }&#10;            }&#10;            return false; // 실패&#10;            &#10;        } finally {&#10;            // --- 5단계: 리소스 정리 ---&#10;            try { if (rs != null) rs.close(); } catch (Exception e) {}&#10;            try { if (pstmtDiary != null) pstmtDiary.close(); } catch (Exception e) {}&#10;            try { if (pstmtEmotion != null) pstmtEmotion.close(); } catch (Exception e) {}&#10;            try { &#10;                if (conn != null) {&#10;                    conn.setAutoCommit(true); &#10;                    conn.close(); &#10;                }&#10;            } catch (Exception e) {}&#10;        }&#10;    }&#10;    &#10;    // 3. 일기 조회 메서드&#10;    public static List&lt;DiaryEntry&gt; getEntries(String title, Timestamp start, Timestamp end) {&#10;        List&lt;DiaryEntry&gt; list = new ArrayList&lt;&gt;();&#10;        String sql = &quot;SELECT * FROM diary WHERE user_id = ?&quot;;&#10;&#10;        if (!title.isEmpty()) sql += &quot; AND title LIKE ?&quot;;&#10;        if (start != null) sql += &quot; AND entry_date &gt;= ?&quot;;&#10;        if (end != null) sql += &quot; AND entry_date &lt;= ?&quot;;&#10;&#10;        sql += &quot; ORDER BY entry_id DESC&quot;;&#10;&#10;        try (Connection conn = getConnection();&#10;                PreparedStatement pstmt = conn.prepareStatement(sql)) {&#10;            int index = 1;&#10;            pstmt.setString(index++, AuthenticationFrame.loggedInUserId);&#10;&#10;            if (!title.isEmpty()) pstmt.setString(index++, &quot;%&quot; + title + &quot;%&quot;);&#10;            if (start != null) pstmt.setTimestamp(index++, start);&#10;            if (end != null) pstmt.setTimestamp(index++, end);&#10;&#10;            try (ResultSet rs = pstmt.executeQuery()) {&#10;&#9;            while (rs.next()) {&#10;&#9;                DiaryEntry entry = new DiaryEntry();&#10;&#9;                entry.setEntry_id(rs.getInt(&quot;entry_id&quot;));&#10;&#9;                entry.setTitle(rs.getString(&quot;title&quot;));&#10;&#9;                entry.setContent(rs.getString(&quot;content&quot;));&#10;&#9;                entry.setStress_level(rs.getInt(&quot;stress_level&quot;));&#10;&#9;                entry.setEntry_date(rs.getTimestamp(&quot;entry_date&quot;));&#10;&#9;                entry.setModify_date(rs.getTimestamp(&quot;modify_date&quot;));&#10;&#9;                entry.setEmotions(getEmotionsByEntryId(conn, entry.getEntry_id()));&#10;&#9;                list.add(entry);&#10;&#9;            }&#10;            }&#10;&#9;    } catch (Exception e) {&#10;&#9;    &#9;System.err.println(&quot;일기 조회 중 오류 발생:&quot;);&#10;&#9;        e.printStackTrace();&#10;&#9;        return list;&#10;&#9;    }&#10;        return list;&#10;    }&#10;&#10;    &#10;    public static List&lt;Emotion&gt; getEmotionsByEntryId(Connection conn, int entryId) throws SQLException {&#10;&#10;        List&lt;Emotion&gt; list = new ArrayList&lt;&gt;();&#10;&#10;        String sql = &quot;SELECT emotion_level, emoji_icon &quot; +&#10;                     &quot;FROM emotion WHERE entry_id = ? &quot; +&#10;                     &quot;ORDER BY emotion_id ASC LIMIT 4&quot;;&#10;&#10;        try (PreparedStatement pstmt = conn.prepareStatement(sql)) {&#10;        &#9;&#10;            pstmt.setInt(1, entryId);&#10;&#10;            try (ResultSet rs = pstmt.executeQuery()) {&#10;                while (rs.next()) {&#10;                    Emotion em = new Emotion();&#10;                    em.setEmotion_level(rs.getInt(&quot;emotion_level&quot;));&#10;                    em.setEmoji_icon(rs.getString(&quot;emoji_icon&quot;));&#10;                    list.add(em);&#10;                }&#10;            }&#10;        }&#10;        return list;&#10;    }&#10;    &#10;    // 4. 일기 수정하는 메서드&#10;    public static boolean updateDiaryEntry(&#10;            int entryId,&#10;            String title,&#10;            String content,&#10;            int stressLevel,&#10;            Timestamp modifyDate,&#10;            List&lt;String&gt; emotionIcons,&#10;            List&lt;Integer&gt; emotionValuesList) {&#10;&#10;        String sqlUpdateDiary =&#10;                &quot;UPDATE diary SET title = ?, content = ?, stress_level = ?, modify_date = ? WHERE entry_id = ?&quot;;&#10;        String sqlDeleteEmotion =&#10;                &quot;DELETE FROM emotion WHERE entry_id = ?&quot;;&#10;        String sqlInsertEmotion =&#10;                &quot;INSERT INTO emotion (entry_id, emotion_level, emoji_icon) VALUES (?, ?, ?)&quot;;&#10;&#10;        try (Connection conn = getConnection()) {&#10;&#10;            conn.setAutoCommit(false); // 자동커밋 꺼두기&#10;&#10;            // 1. diary 업데이트&#10;            try (PreparedStatement pstmt = conn.prepareStatement(sqlUpdateDiary)) {&#10;                pstmt.setString(1, title);&#10;                pstmt.setString(2, content);&#10;                pstmt.setInt(3, stressLevel);&#10;                pstmt.setTimestamp(4, modifyDate);&#10;                pstmt.setInt(5, entryId);&#10;                pstmt.executeUpdate();&#10;            }&#10;&#10;            // 2. 기존 emotion 삭제&#10;            try (PreparedStatement pstmt = conn.prepareStatement(sqlDeleteEmotion)) {&#10;                pstmt.setInt(1, entryId);&#10;                pstmt.executeUpdate();&#10;            }&#10;&#10;            // 3. 새 emotion 삽입&#10;            try (PreparedStatement pstmt = conn.prepareStatement(sqlInsertEmotion)) {&#10;                for (int i = 0; i &lt; emotionIcons.size(); i++) {&#10;                    pstmt.setInt(1, entryId);&#10;                    pstmt.setInt(2, emotionValuesList.get(i));&#10;                    pstmt.setString(3, emotionIcons.get(i));&#10;                    pstmt.addBatch();&#10;                }&#10;                pstmt.executeBatch();&#10;            }&#10;&#10;            conn.commit();&#10;            return true;&#10;&#10;        } catch (Exception e) {&#10;        &#9;System.err.println(&quot;일기 수정 중 오류 발생:&quot;);&#10;            e.printStackTrace();&#10;            return false;&#10;        }&#10;    }&#10;&#10;&#10;    // 5. 일기 삭제하는 메서드&#10;    public static boolean deleteEntry(int entryId) {&#10;        String sqlDeleteEmotion = &quot;DELETE FROM emotion WHERE entry_id = ?&quot;;&#10;        String sqlDeleteDiary = &quot;DELETE FROM diary WHERE entry_id = ?&quot;;&#10;&#10;        try (Connection conn = getConnection()) {&#10;            conn.setAutoCommit(false);&#10;&#10;            // 감정 먼저 삭제&#10;            try (PreparedStatement pstmt = conn.prepareStatement(sqlDeleteEmotion)) {&#10;                pstmt.setInt(1, entryId);&#10;                pstmt.executeUpdate();&#10;            }&#10;&#10;            // 일기 삭제&#10;            try (PreparedStatement pstmt = conn.prepareStatement(sqlDeleteDiary)) {&#10;                pstmt.setInt(1, entryId);&#10;                pstmt.executeUpdate();&#10;            }&#10;&#10;            conn.commit();&#10;            return true;&#10;&#10;        } catch (Exception e) {&#10;        &#9;System.err.println(&quot;일기 삭제 중 오류 발생:&quot;);&#10;            e.printStackTrace();&#10;            return false;&#10;        }&#10;    }&#10;&#10;    &#10;}" />
              <option name="updatedContent" value="package com.diary.emotion.DB;&#10;&#10;import java.sql.Connection;&#10;import java.sql.DriverManager;&#10;import java.sql.PreparedStatement;&#10;import java.sql.ResultSet;&#10;import java.sql.SQLException;&#10;import java.sql.Statement;&#10;import java.sql.Timestamp;&#10;import java.time.LocalDateTime;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;import com.diary.emotion.login.AuthenticationFrame;&#10;&#10;// ⭐️ 프로그램 실행 중 DB 연결/삽입/조회/수정 등을 관리하는 전용 클래스&#10;public class DatabaseManager {&#10;&#10;    // ⭐️ 이 클래스는 'emotion_diary' DB에 바로 연결&#10;    private static final String DB_URL = &quot;jdbc:mysql://localhost:3306/emotion_diary?serverTimezone=Asia/Seoul&amp;characterEncoding=UTF-8&amp;useUnicode=true&quot;;&#10;&#9;private static final String DB_ID = &quot;root&quot;;&#10;&#9;private static final String DB_PW = &quot;U9Bsi7sj1*&quot;; // 비번&#10;&#9;&#10;    // 1. DB 연결을 가져오는 메소드&#10;    public static Connection getConnection() throws Exception {&#10;        return DriverManager.getConnection(DB_URL, DB_ID, DB_PW);&#10;    }&#10;    &#10;    // 처음 DB 생성을 위한 URL&#10;    private static final String Initial_DB_URL = &quot;jdbc:mysql://localhost:3306/?serverTimezone=Asia/Seoul&amp;characterEncoding=UTF-8&amp;useUnicode=true&quot;;&#10;    &#10;    // DB 생성 메서드&#10;    public static boolean createDatabase() {&#10;&#9;&#10;    &#9;try (Connection conn = DriverManager.getConnection(Initial_DB_URL, DB_ID, DB_PW);&#10;    &#9;&#9;     Statement stmt = conn.createStatement();&#10;    &#9;&#9;     ResultSet rs = stmt.executeQuery(&quot;SHOW DATABASES LIKE 'emotion_diary'&quot;)) {&#10;&#10;    &#9;&#9;    if (!rs.next()) { // 해당 DB가 없으면 실행&#10;            &#9;&#10;            &#9;// DB 생성&#10;            &#9;String sql = &quot;CREATE DATABASE emotion_diary CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci&quot;; // 이모지 저장 및 대소문자 구분 없는 유니코드 문자셋 설정&#10;&#9;&#9;        stmt.executeUpdate(sql);&#10;&#9;&#9;        &#10;&#9;&#9;        // 해당 DB 사용&#10;&#9;&#9;        String useEmotion_diaryDB = &quot;USE emotion_diary&quot;;&#10;&#9;&#9;        stmt.executeUpdate(useEmotion_diaryDB);&#10;&#9;&#10;&#9;            // user 테이블 생성&#10;&#9;            String createTable_user = &quot;&quot;&quot;&#10;&#9;                CREATE TABLE user (&#10;&#9;                    user_id VARCHAR(20) PRIMARY KEY,&#10;&#9;                    user_pw VARCHAR(20) NOT NULL&#10;&#9;                )&#10;&#9;            &quot;&quot;&quot;;&#10;&#9;            stmt.executeUpdate(createTable_user);&#10;&#9;            &#10;&#9;            // diary 테이블 생성&#10;&#9;            String createTable_diary = &quot;&quot;&quot;&#10;&#9;                CREATE TABLE diary (&#10;&#9;                    entry_id INTEGER AUTO_INCREMENT PRIMARY KEY,&#10;&#9;                    user_id VARCHAR(20) NOT NULL,&#10;&#9;                    title VARCHAR(50),&#10;&#9;                    content TEXT,&#10;&#9;                    stress_level INTEGER NOT NULL,&#10;&#9;                    entry_date DATETIME NOT NULL,&#10;&#9;                    modify_date DATETIME,&#10;&#9;                    FOREIGN KEY (user_id) REFERENCES user(user_id)&#10;&#9;                )&#10;&#9;            &quot;&quot;&quot;;&#10;&#9;            stmt.executeUpdate(createTable_diary);&#10;&#9;            &#10;            // emotion 테이블 생성&#10;            String createTable_emotion = &quot;&quot;&quot;&#10;                CREATE TABLE emotion (&#10;                    emotion_id INTEGER AUTO_INCREMENT PRIMARY KEY,&#10;                    entry_id INTEGER NOT NULL,&#10;                    emotion_level INTEGER NOT NULL,&#10;                    emoji_icon VARCHAR(10) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL,&#10;                    FOREIGN KEY (entry_id) REFERENCES diary(entry_id)&#10;                )&#10;            &quot;&quot;&quot;;&#10;            stmt.executeUpdate(createTable_emotion);&#10;&#9;                &#10;&#9;            // question 테이블 생성&#10;&#9;            String createTable_question = &quot;&quot;&quot;&#10;&#9;                CREATE TABLE question (&#10;&#9;                    question_id INTEGER AUTO_INCREMENT PRIMARY KEY,&#10;&#9;                    question_text VARCHAR(100) NOT NULL&#10;&#9;                )&#10;&#9;            &quot;&quot;&quot;;&#10;&#9;            stmt.executeUpdate(createTable_question);&#10;            }&#10;&#10;&#9;        return true;&#10;&#9;        &#10;&#9;    } catch (Exception e) {&#10;&#9;    &#9;System.err.println(&quot;일기 삭제 중 오류 발생:&quot;);&#10;&#9;    &#9;e.printStackTrace(); // 오류 콘솔에 출력 (디버깅용)&#10;&#9;    &#9;&#10;&#9;    &#9;return false;&#10;&#9;    }&#10;&#9;}&#10;    &#10;    // 1. 로그인 기능: ID와 비번을 받아서 맞으면 true, 틀리면 false 반환&#10;    public boolean checkLogin(String id, String pw) {&#10;        String sql = &quot;SELECT user_pw FROM user WHERE user_id = ?&quot;;&#10;        try (Connection conn = DriverManager.getConnection(DB_URL, DB_ID, DB_PW);&#10;             PreparedStatement pstmt = conn.prepareStatement(sql)) {&#10;&#10;            pstmt.setString(1, id);&#10;            try (ResultSet rs = pstmt.executeQuery()) {&#10;                if (rs.next()) {&#10;                    return pw.equals(rs.getString(&quot;user_pw&quot;));&#10;                }&#10;            }&#10;&#10;        } catch (Exception e) {&#10;            e.printStackTrace();&#10;        }&#10;        return false;&#10;    }&#10;&#10;    // 2. 회원가입 기능: 성공(1), 중복ID(0), 에러(-1) 반환&#10;    public int registerUser(String id, String pw) {&#10;        String checkSql = &quot;SELECT user_id FROM user WHERE user_id = ?&quot;;&#10;        String insertSql = &quot;INSERT INTO user (user_id, user_pw) VALUES (?, ?)&quot;;&#10;&#10;        try (Connection conn = DriverManager.getConnection(DB_URL, DB_ID, DB_PW)) {&#10;            &#10;            // ID 중복 확인&#10;            try (PreparedStatement checkStmt = conn.prepareStatement(checkSql)) {&#10;                checkStmt.setString(1, id);&#10;                try (ResultSet rs = checkStmt.executeQuery()) {&#10;                    if (rs.next()) return 0; &#10;                }&#10;            }&#10;&#10;            // 회원가입&#10;            try (PreparedStatement insertStmt = conn.prepareStatement(insertSql)) {&#10;                insertStmt.setString(1, id);&#10;                insertStmt.setString(2, pw);&#10;                insertStmt.executeUpdate();&#10;                return 1;&#10;            }&#10;&#10;        } catch (Exception e) {&#10;            e.printStackTrace();&#10;            return -1;&#10;        }&#10;    }&#10;&#10;    // 2. 일기 항목을 DB에 삽입하는 메소드&#10;    public static boolean insertDiaryEntry(String title, String content, int stressLevel, &#10;                                           List&lt;String&gt; emotionIcons, List&lt;Integer&gt; emotionValuesList) {&#10;        &#10;        Connection conn = null;&#10;        PreparedStatement pstmtDiary = null;&#10;        PreparedStatement pstmtEmotion = null;&#10;        ResultSet rs = null;&#10;&#10;        String sqlInsertDiary = &quot;INSERT INTO diary (user_id, title, content, stress_level, entry_date) VALUES (?, ?, ?, ?, ?)&quot;;&#10;        String sqlInsertEmotion = &quot;INSERT INTO emotion (entry_id, emotion_level, emoji_icon) VALUES (?, ?, ?)&quot;;&#10;&#10;        try {&#10;            conn = getConnection(); &#10;            conn.setAutoCommit(false); &#10;            &#10;            // --- 1단계: 'diary' 테이블에 삽입 ---&#10;            pstmtDiary = conn.prepareStatement(sqlInsertDiary, Statement.RETURN_GENERATED_KEYS);&#10;            pstmtDiary.setString(1, AuthenticationFrame.loggedInUserId);&#10;            pstmtDiary.setString(2, title.trim()); // 앞 뒤 공백 제거&#10;            pstmtDiary.setString(3, content);&#10;            pstmtDiary.setInt(4, stressLevel);&#10;            pstmtDiary.setTimestamp(5, Timestamp.valueOf(LocalDateTime.now()));&#10;            &#10;            int rowsAffected = pstmtDiary.executeUpdate();&#10;            &#10;            if (rowsAffected == 0) {&#10;                throw new Exception(&quot;Diary insert failed, no rows affected.&quot;);&#10;            }&#10;&#10;            // --- 2단계: 방금 삽입된 'diary'의 entry_id 가져오기 ---&#10;            rs = pstmtDiary.getGeneratedKeys();&#10;            int entryId;&#10;            if (rs.next()) {&#10;                entryId = rs.getInt(1); &#10;            } else {&#10;                throw new Exception(&quot;Diary insert failed, no ID obtained.&quot;);&#10;            }&#10;            &#10;            // --- 3단계: 'emotion' 테이블에 삽입 ---&#10;            pstmtEmotion = conn.prepareStatement(sqlInsertEmotion);&#10;            &#10;            for (int i = 0; i &lt; emotionIcons.size(); i++) {&#10;                pstmtEmotion.setInt(1, entryId);&#10;                pstmtEmotion.setInt(2, emotionValuesList.get(i));&#10;                pstmtEmotion.setString(3, emotionIcons.get(i));&#10;                pstmtEmotion.addBatch();&#10;            }&#10;            pstmtEmotion.executeBatch(); &#10;&#10;            // --- 4단계: 최종 반영 ---&#10;            conn.commit();&#10;            return true; // 성공!&#10;&#10;        } catch (Exception e) {&#10;            e.printStackTrace();&#10;            if (conn != null) {&#10;                try {&#10;                    conn.rollback(); // 실패 시 되돌리기&#10;                } catch (Exception ex) {&#10;                    ex.printStackTrace();&#10;                }&#10;            }&#10;            return false; // 실패&#10;            &#10;        } finally {&#10;            // --- 5단계: 리소스 정리 ---&#10;            try { if (rs != null) rs.close(); } catch (Exception e) {}&#10;            try { if (pstmtDiary != null) pstmtDiary.close(); } catch (Exception e) {}&#10;            try { if (pstmtEmotion != null) pstmtEmotion.close(); } catch (Exception e) {}&#10;            try { &#10;                if (conn != null) {&#10;                    conn.setAutoCommit(true); &#10;                    conn.close(); &#10;                }&#10;            } catch (Exception e) {}&#10;        }&#10;    }&#10;    &#10;    // 3. 일기 조회 메서드&#10;    public static List&lt;DiaryEntry&gt; getEntries(String title, Timestamp start, Timestamp end) {&#10;        List&lt;DiaryEntry&gt; list = new ArrayList&lt;&gt;();&#10;        String sql = &quot;SELECT * FROM diary WHERE user_id = ?&quot;;&#10;&#10;        if (!title.isEmpty()) sql += &quot; AND title LIKE ?&quot;;&#10;        if (start != null) sql += &quot; AND entry_date &gt;= ?&quot;;&#10;        if (end != null) sql += &quot; AND entry_date &lt;= ?&quot;;&#10;&#10;        sql += &quot; ORDER BY entry_id DESC&quot;;&#10;&#10;        try (Connection conn = getConnection();&#10;                PreparedStatement pstmt = conn.prepareStatement(sql)) {&#10;            int index = 1;&#10;            pstmt.setString(index++, AuthenticationFrame.loggedInUserId);&#10;&#10;            if (!title.isEmpty()) pstmt.setString(index++, &quot;%&quot; + title + &quot;%&quot;);&#10;            if (start != null) pstmt.setTimestamp(index++, start);&#10;            if (end != null) pstmt.setTimestamp(index++, end);&#10;&#10;            try (ResultSet rs = pstmt.executeQuery()) {&#10;&#9;            while (rs.next()) {&#10;&#9;                DiaryEntry entry = new DiaryEntry();&#10;&#9;                entry.setEntry_id(rs.getInt(&quot;entry_id&quot;));&#10;&#9;                entry.setTitle(rs.getString(&quot;title&quot;));&#10;&#9;                entry.setContent(rs.getString(&quot;content&quot;));&#10;&#9;                entry.setStress_level(rs.getInt(&quot;stress_level&quot;));&#10;&#9;                entry.setEntry_date(rs.getTimestamp(&quot;entry_date&quot;));&#10;&#9;                entry.setModify_date(rs.getTimestamp(&quot;modify_date&quot;));&#10;&#9;                entry.setEmotions(getEmotionsByEntryId(conn, entry.getEntry_id()));&#10;&#9;                list.add(entry);&#10;&#9;            }&#10;            }&#10;&#9;    } catch (Exception e) {&#10;&#9;    &#9;System.err.println(&quot;일기 조회 중 오류 발생:&quot;);&#10;&#9;        e.printStackTrace();&#10;&#9;        return list;&#10;&#9;    }&#10;        return list;&#10;    }&#10;&#10;    &#10;    public static List&lt;Emotion&gt; getEmotionsByEntryId(Connection conn, int entryId) throws SQLException {&#10;&#10;        List&lt;Emotion&gt; list = new ArrayList&lt;&gt;();&#10;&#10;        String sql = &quot;SELECT emotion_level, emoji_icon &quot; +&#10;                     &quot;FROM emotion WHERE entry_id = ? &quot; +&#10;                     &quot;ORDER BY emotion_id ASC LIMIT 4&quot;;&#10;&#10;        try (PreparedStatement pstmt = conn.prepareStatement(sql)) {&#10;        &#9;&#10;            pstmt.setInt(1, entryId);&#10;&#10;            try (ResultSet rs = pstmt.executeQuery()) {&#10;                while (rs.next()) {&#10;                    Emotion em = new Emotion();&#10;                    em.setEmotion_level(rs.getInt(&quot;emotion_level&quot;));&#10;                    em.setEmoji_icon(rs.getString(&quot;emoji_icon&quot;));&#10;                    list.add(em);&#10;                }&#10;            }&#10;        }&#10;        return list;&#10;    }&#10;    &#10;    // 4. 일기 수정하는 메서드&#10;    public static boolean updateDiaryEntry(&#10;            int entryId,&#10;            String title,&#10;            String content,&#10;            int stressLevel,&#10;            Timestamp modifyDate,&#10;            List&lt;String&gt; emotionIcons,&#10;            List&lt;Integer&gt; emotionValuesList) {&#10;&#10;        String sqlUpdateDiary =&#10;                &quot;UPDATE diary SET title = ?, content = ?, stress_level = ?, modify_date = ? WHERE entry_id = ?&quot;;&#10;        String sqlDeleteEmotion =&#10;                &quot;DELETE FROM emotion WHERE entry_id = ?&quot;;&#10;        String sqlInsertEmotion =&#10;                &quot;INSERT INTO emotion (entry_id, emotion_level, emoji_icon) VALUES (?, ?, ?)&quot;;&#10;&#10;        try (Connection conn = getConnection()) {&#10;&#10;            conn.setAutoCommit(false); // 자동커밋 꺼두기&#10;&#10;            // 1. diary 업데이트&#10;            try (PreparedStatement pstmt = conn.prepareStatement(sqlUpdateDiary)) {&#10;                pstmt.setString(1, title);&#10;                pstmt.setString(2, content);&#10;                pstmt.setInt(3, stressLevel);&#10;                pstmt.setTimestamp(4, modifyDate);&#10;                pstmt.setInt(5, entryId);&#10;                pstmt.executeUpdate();&#10;            }&#10;&#10;            // 2. 기존 emotion 삭제&#10;            try (PreparedStatement pstmt = conn.prepareStatement(sqlDeleteEmotion)) {&#10;                pstmt.setInt(1, entryId);&#10;                pstmt.executeUpdate();&#10;            }&#10;&#10;            // 3. 새 emotion 삽입&#10;            try (PreparedStatement pstmt = conn.prepareStatement(sqlInsertEmotion)) {&#10;                for (int i = 0; i &lt; emotionIcons.size(); i++) {&#10;                    pstmt.setInt(1, entryId);&#10;                    pstmt.setInt(2, emotionValuesList.get(i));&#10;                    pstmt.setString(3, emotionIcons.get(i));&#10;                    pstmt.addBatch();&#10;                }&#10;                pstmt.executeBatch();&#10;            }&#10;&#10;            conn.commit();&#10;            return true;&#10;&#10;        } catch (Exception e) {&#10;        &#9;System.err.println(&quot;일기 수정 중 오류 발생:&quot;);&#10;            e.printStackTrace();&#10;            return false;&#10;        }&#10;    }&#10;&#10;&#10;    // 5. 일기 삭제하는 메서드&#10;    public static boolean deleteEntry(int entryId) {&#10;        String sqlDeleteEmotion = &quot;DELETE FROM emotion WHERE entry_id = ?&quot;;&#10;        String sqlDeleteDiary = &quot;DELETE FROM diary WHERE entry_id = ?&quot;;&#10;&#10;        try (Connection conn = getConnection()) {&#10;            conn.setAutoCommit(false);&#10;&#10;            // 감정 먼저 삭제&#10;            try (PreparedStatement pstmt = conn.prepareStatement(sqlDeleteEmotion)) {&#10;                pstmt.setInt(1, entryId);&#10;                pstmt.executeUpdate();&#10;            }&#10;&#10;            // 일기 삭제&#10;            try (PreparedStatement pstmt = conn.prepareStatement(sqlDeleteDiary)) {&#10;                pstmt.setInt(1, entryId);&#10;                pstmt.executeUpdate();&#10;            }&#10;&#10;            conn.commit();&#10;            return true;&#10;&#10;        } catch (Exception e) {&#10;        &#9;System.err.println(&quot;일기 삭제 중 오류 발생:&quot;);&#10;            e.printStackTrace();&#10;            return false;&#10;        }&#10;    }&#10;&#10;    &#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>